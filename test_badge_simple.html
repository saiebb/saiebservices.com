<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار شارة Google Customer Reviews</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .badge-container { 
            border: 2px dashed #007bff; 
            padding: 20px; 
            margin: 20px 0; 
            min-height: 120px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .log-container { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-10 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">🏆 اختبار شارة آراء العملاء عبر Google</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <h5>📋 معلومات الاختبار:</h5>
                            <ul class="mb-0">
                                <li><strong>معرف التاجر:</strong> 5349752399</li>
                                <li><strong>نوع الاختبار:</strong> شارة آراء العملاء</li>
                                <li><strong>المتوقع:</strong> عرض تقييم البائع أو رسالة "لا تتوفر تقييمات"</li>
                            </ul>
                        </div>

                        <!-- مكان عرض الشارة -->
                        <div class="text-center">
                            <h5>🎯 شارة آراء العملاء:</h5>
                            <div id="google-reviews-badge" class="badge-container">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">جاري التحميل...</span>
                                        </div>
                                        <p class="mt-2 text-muted">جاري تحميل الشارة...</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- أزرار التحكم -->
                        <div class="text-center mb-4">
                            <button id="reloadBadge" class="btn btn-primary">🔄 إعادة تحميل الشارة</button>
                            <button id="clearLog" class="btn btn-secondary">🗑️ مسح السجل</button>
                        </div>

                        <!-- سجل الأحداث -->
                        <div>
                            <h5>📊 سجل الأحداث:</h5>
                            <div id="eventLog" class="log-container"></div>
                        </div>

                        <!-- معلومات إضافية -->
                        <div class="alert alert-warning mt-4">
                            <h6>⚠️ ملاحظات مهمة:</h6>
                            <ul class="mb-0">
                                <li>إذا ظهرت رسالة "لا تتوفر تقييمات" فهذا طبيعي للحسابات الجديدة</li>
                                <li>الشارة تحتاج تقييمات فعلية من العملاء لتظهر</li>
                                <li>قد تستغرق التقييمات وقتاً لتظهر في النظام</li>
                                <li>تأكد من تفعيل برنامج Customer Reviews في Google Merchant Center</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // إعداد نظام التسجيل
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToEventLog(message, type = 'log') {
            const logDiv = document.getElementById('eventLog');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const colors = {
                'log': 'text-dark',
                'error': 'text-danger',
                'warn': 'text-warning',
                'success': 'text-success'
            };
            const color = colors[type] || 'text-dark';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToEventLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToEventLog('❌ ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToEventLog('⚠️ ' + args.join(' '), 'warn');
        };

        // بدء الاختبار عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 بدء اختبار شارة Google Customer Reviews');
            console.log('📋 معرف التاجر: 5349752399');
            
            loadGoogleRatingBadge();
            
            // إعداد أزرار التحكم
            document.getElementById('reloadBadge').addEventListener('click', function() {
                console.log('🔄 إعادة تحميل الشارة...');
                const badgeContainer = document.getElementById('google-reviews-badge');
                badgeContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2 text-muted">جاري إعادة التحميل...</p></div></div>';
                setTimeout(() => loadGoogleRatingBadge(), 1000);
            });
            
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('eventLog').innerHTML = '';
                console.log('🗑️ تم مسح السجل');
            });
        });

        // تحميل شارة Google Customer Reviews
        function loadGoogleRatingBadge() {
            console.log('📥 بدء تحميل Google API...');
            
            const badgeContainer = document.getElementById('google-reviews-badge');
            if (!badgeContainer) {
                console.error('❌ لم يتم العثور على حاوي الشارة');
                return;
            }
            
            // تحميل Google API
            if (typeof gapi === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/platform.js?onload=renderGoogleBadge';
                script.async = true;
                script.defer = true;
                script.onload = function() {
                    console.log('✅ تم تحميل Google API بنجاح');
                };
                script.onerror = function() {
                    console.error('❌ فشل في تحميل Google API');
                    badgeContainer.innerHTML = '<div class="alert alert-danger">فشل في تحميل Google API</div>';
                };
                document.head.appendChild(script);
            } else {
                console.log('✅ Google API محمل مسبقاً');
                renderGoogleBadge();
            }
        }

        // عرض الشارة
        function renderGoogleBadge() {
            console.log('🏆 بدء عرض شارة آراء العملاء...');
            
            const badgeContainer = document.getElementById('google-reviews-badge');
            if (!badgeContainer) {
                console.error('❌ لم يتم العثور على حاوي الشارة');
                return;
            }
            
            if (typeof gapi !== 'undefined') {
                console.log('🔧 تحميل مكون ratingbadge...');
                
                gapi.load('ratingbadge', function() {
                    try {
                        console.log('🎯 عرض الشارة بمعرف التاجر: 5349752399');
                        
                        // مسح المحتوى المؤقت
                        badgeContainer.innerHTML = '';
                        
                        // عرض الشارة
                        gapi.ratingbadge.render(badgeContainer, {
                            "merchant_id": 5349752399
                        });
                        
                        console.log('✅ تم استدعاء عرض الشارة بنجاح');
                        
                        // فحص النتيجة بعد 3 ثوان
                        setTimeout(() => {
                            if (badgeContainer.children.length > 0) {
                                console.log('🎉 تم عرض الشارة بنجاح!');
                                addToEventLog('🎉 تم عرض الشارة بنجاح!', 'success');
                            } else {
                                console.warn('⚠️ لم يتم عرض الشارة - قد لا تتوفر تقييمات');
                                badgeContainer.innerHTML = '<div class="alert alert-info text-center"><h6>📝 لا تتوفر تقييمات حالياً</h6><p class="mb-0">سيتم عرض الشارة عند توفر تقييمات من العملاء</p></div>';
                            }
                        }, 3000);
                        
                    } catch (error) {
                        console.error('❌ خطأ في عرض الشارة:', error.message);
                        badgeContainer.innerHTML = '<div class="alert alert-danger text-center"><h6>❌ خطأ في تحميل الشارة</h6><p class="mb-0">' + error.message + '</p></div>';
                    }
                });
            } else {
                console.error('❌ Google API غير متوفر');
                badgeContainer.innerHTML = '<div class="alert alert-danger text-center">Google API غير متوفر</div>';
            }
        }

        // جعل الدالة متاحة عالمياً
        window.renderGoogleBadge = renderGoogleBadge;
    </script>
</body>
</html>