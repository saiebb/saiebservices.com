<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار Google Customer Reviews</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .console-log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 10px; 
            margin: 10px 0; 
            font-family: monospace; 
            max-height: 300px; 
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header">
                        <h4>اختبار Google Customer Reviews</h4>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <strong>تعليمات الاختبار:</strong>
                            <ol>
                                <li>املأ النموذج أدناه</li>
                                <li>فعّل خيار الموافقة على Google Reviews</li>
                                <li>اضغط "إرسال الطلب"</li>
                                <li>راقب سجل وحدة التحكم أدناه</li>
                            </ol>
                        </div>

                        <form id="testForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label>الاسم:</label>
                                        <input type="text" id="test_name" class="form-control" value="أحمد محمد" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label>البريد الإلكتروني:</label>
                                        <input type="email" id="test_email" class="form-control" value="ahmed@example.com" required>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="test_google_consent" value="1">
                                    <label class="form-check-label" for="test_google_consent">
                                        <strong>أوافق على مشاركة تجربتي مع خدمات صيب عبر آراء العملاء في Google</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg">إرسال الطلب</button>
                                <button type="button" id="clearLog" class="btn btn-secondary btn-sm">مسح السجل</button>
                            </div>
                        </form>

                        <div class="mt-4">
                            <h5>سجل وحدة التحكم:</h5>
                            <div id="consoleLog" class="console-log"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // إعادة توجيه console.log لعرضه في الصفحة
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(message, type = 'log') {
            const logDiv = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            const color = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-dark';
            logDiv.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog('❌ ' + args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog('⚠️ ' + args.join(' '), 'warn');
        };

        document.addEventListener('DOMContentLoaded', function() {
            console.log('✓ تم تحميل الصفحة بنجاح');
            
            // تحميل Google API
            loadGoogleAPI();
            
            document.getElementById('testForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                console.log('📝 بدء معالجة النموذج...');
                
                const formData = {
                    name: document.getElementById('test_name').value,
                    email: document.getElementById('test_email').value,
                    google_consent: document.getElementById('test_google_consent').checked
                };
                
                console.log('📊 بيانات النموذج:', JSON.stringify(formData));
                
                if (formData.google_consent) {
                    console.log('✅ العميل وافق على Google Reviews - سيتم عرض النموذج...');
                    setTimeout(() => {
                        showGoogleCustomerReviews(formData);
                    }, 1500);
                } else {
                    console.log('❌ العميل لم يوافق على Google Reviews');
                }
            });
            
            document.getElementById('clearLog').addEventListener('click', function() {
                document.getElementById('consoleLog').innerHTML = '';
            });
        });

        // تحميل Google API
        function loadGoogleAPI() {
            console.log('🔄 بدء تحميل Google API...');
            
            if (typeof gapi === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/platform.js?onload=initGoogleAPI';
                script.async = true;
                script.defer = true;
                script.onload = function() {
                    console.log('✅ تم تحميل ملف Google API بنجاح');
                };
                script.onerror = function() {
                    console.error('❌ فشل في تحميل Google API');
                };
                document.head.appendChild(script);
            } else {
                console.log('✅ Google API محمل مسبقاً');
                initGoogleAPI();
            }
        }

        // تهيئة Google API
        function initGoogleAPI() {
            console.log('🔧 تهيئة Google API...');
            
            if (typeof gapi !== 'undefined') {
                gapi.load('surveyoptin', function() {
                    console.log('✅ تم تحميل Google Customer Reviews API بنجاح');
                });
            } else {
                console.error('❌ Google API غير متوفر');
            }
        }

        // عرض Google Customer Reviews
        function showGoogleCustomerReviews(customerData) {
            console.log('🎯 محاولة عرض Google Customer Reviews...');
            
            if (typeof gapi !== 'undefined' && gapi.surveyoptin) {
                try {
                    const orderId = 'SAIEB-TEST-' + Date.now() + '-' + Math.random().toString(36).substr(2, 6).toUpperCase();
                    
                    const estimatedDelivery = new Date();
                    estimatedDelivery.setDate(estimatedDelivery.getDate() + 7);
                    const deliveryDate = estimatedDelivery.toISOString().split('T')[0];
                    
                    console.log('📋 بيانات الطلب:', JSON.stringify({
                        orderId: orderId,
                        email: customerData.email,
                        deliveryDate: deliveryDate
                    }));
                    
                    gapi.surveyoptin.render({
                        "merchant_id": 5349752399,
                        "order_id": orderId,
                        "email": customerData.email,
                        "delivery_country": "SA",
                        "estimated_delivery_date": deliveryDate,
                        // إزالة products لتجنب مشاكل GTIN
                        // "products": [{
                        //     "gtin": "SAIEB_SERVICE_TEST_123"
                        // }],
                        "opt_in_style": "OPT_IN_STYLE_CENTER_DIALOG"
                    });
                    
                    console.log('✅ تم استدعاء Google Customer Reviews للعميل: ' + customerData.name);
                    
                } catch (error) {
                    console.error('❌ خطأ في عرض Google Customer Reviews:', error.message);
                }
            } else {
                console.warn('⚠️ Google API غير جاهز - محاولة أخرى بعد ثانية واحدة...');
                setTimeout(() => showGoogleCustomerReviews(customerData), 1000);
            }
        }
    </script>
</body>
</html>